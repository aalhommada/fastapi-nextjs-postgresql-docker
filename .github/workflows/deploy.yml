name: Auto-Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DROPLET_IP: 165.232.86.188
  APP_PATH: /opt/app/fastapi-nextjs-postgresql-docker

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to DigitalOcean Droplet
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.DROPLET_IP }}
        username: root
        password: ${{ secrets.DROPLET_PASSWORD }}
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to app directory
          cd ${{ env.APP_PATH }}
          
          # Pull latest changes from GitHub
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # Stop existing containers gracefully
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose down --timeout 30
          
          # Clean up old images and containers
          echo "ğŸ§¹ Cleaning up old images..."
          docker system prune -f --volumes
          
          # Build new images
          echo "ğŸ”¨ Building new images..."
          docker-compose build --no-cache --parallel
          
          # Start services
          echo "ğŸš€ Starting services..."
          docker-compose up -d
          
          # Wait for services to be healthy
          echo "â³ Waiting for services to be ready..."
          timeout=300  # 5 minutes
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            if docker-compose ps | grep -q "healthy"; then
              echo "âœ… Services are healthy!"
              break
            fi
            sleep 10
            elapsed=$((elapsed + 10))
            echo "â³ Waiting... (${elapsed}s)"
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "âŒ Services failed to become healthy within timeout"
            docker-compose logs
            exit 1
          fi
          
          # Final status check
          echo "ğŸ“Š Final status check..."
          docker-compose ps
          
          # Test endpoints
          echo "ğŸ” Testing endpoints..."
          sleep 5
          
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            docker-compose logs backend
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ”— Backend API: http://${{ env.DROPLET_IP }}:8000"
          echo "ğŸ“‹ API Docs: http://${{ env.DROPLET_IP }}:8000/docs"
          echo "ğŸ• Deployment time: $(date)"
          
          # Clean up old images after successful deployment
          docker image prune -f