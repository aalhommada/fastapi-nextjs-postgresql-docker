name: Deploy to DigitalOcean

# Completely disabled to avoid SSH key errors
# This workflow is disabled until SSH keys are properly configured
on:
  workflow_dispatch:
    inputs:
      skip_deployment:
        description: 'Skip deployment (workflow disabled)'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: false  # This completely disables the job
    
    steps:
    - name: Disabled
      run: |
        echo "This workflow is temporarily disabled"
        echo "Manual deployment required on droplet"
        exit 0

    - name: Deploy to DigitalOcean Droplet
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'EOF'
          # Navigate to app directory
          cd /opt/app || { echo "App directory not found"; exit 1; }
          
          # Pull latest changes
          echo "Pulling latest changes from GitHub..."
          git pull origin main
          
          # Stop current containers
          echo "Stopping current containers..."
          docker-compose -f docker-compose.production.yml down
          
          # Rebuild and start containers
          echo "Building and starting new containers..."
          docker-compose -f docker-compose.production.yml --env-file .env.production up --build -d
          
          # Clean up unused images
          echo "Cleaning up unused Docker images..."
          docker image prune -f
          
          # Check container status
          echo "Checking container status..."
          docker-compose -f docker-compose.production.yml ps
          
          echo "Deployment completed successfully!"
        EOF

    - name: Health Check
      run: |
        echo "Waiting for services to start..."
        sleep 60
        
        # Check if the site is responding
        echo "Checking site health..."
        curl -f https://aalhommada.com/api/health || exit 1
        
        echo "Health check passed!"

    - name: Notify Success
      if: success()
      run: |
        echo "🎉 Deployment successful!"
        echo "Site is live at: https://aalhommada.com"

    - name: Notify Failure
      if: failure()
      run: |
        echo "❌ Deployment failed!"
        echo "Check the logs for more information."
